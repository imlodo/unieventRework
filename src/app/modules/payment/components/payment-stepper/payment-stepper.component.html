<div class="container py-5">
    <mat-stepper class="shadow" headerPosition="top" (selectionChange)="setActiveStep($event.selectedIndex)" #stepper>
        <mat-step [stepControl]="firstFormGroup">
            <form [formGroup]="firstFormGroup">
                <ng-template matStepLabel>Consegna</ng-template>
                <unievent-payment-step1-form></unievent-payment-step1-form>
                <div class="py-3 d-flex justify-content-end mt-4">
                    <button class="btn btn-primary btn-color-no-hover rounded-0" mat-button
                        matStepperNext>Avanti</button>
                </div>
            </form>
        </mat-step>
        <mat-step [stepControl]="secondFormGroup">
            <form [formGroup]="secondFormGroup">
                <ng-template matStepLabel>Pagamento</ng-template>
                <div class="container d-flex flex-column mb-5">
                    <h1>Metodo di pagamento</h1>
                    <unievent-payment-step2-payment-method-form></unievent-payment-step2-payment-method-form>
                    <div class="text-secondary mt-4"
                        *ngIf="cardList.length > 0 && paymentMethodStep2FormComponent?.contrassegnoSelected === 'Carta di credito'">
                        <span>Lista carte di credito</span>
                        <div class="row">
                            <div (click)="selectedCardIndex = i" class="col-xl-4 col-12 mt-3 pointer"
                                *ngFor="let card of cardList; let i = index">
                                <div class="credit-card shadow">
                                    <div class="credit-card__front">
                                        <div class="credit-card__logo d-flex flex-row">
                                            <input [checked]="selectedCardIndex === i" class="pointer form-check-input"
                                                type="radio" name="cardRadio" [id]="'card-'+i" [value]="i"
                                                (change)="selectCard(i)">
                                            <div class="card_logo_img mx-1" style="margin-top:2px">
                                                <img class="mx-2" width="40px" src="/assets/img/visa_logo.png"
                                                    alt="Card Logo">
                                            </div>
                                        </div>
                                        <div class="credit-card__number">
                                            {{getCardNumber(card.cardNumber)}}
                                        </div>
                                        <div class="credit-card__info">
                                            <div class="credit-card__info--name">
                                                {{card.cardName}}
                                            </div>
                                            <div class="credit-card__info--expiry">
                                                Scadenza: {{getExpiryDate(card.expiryDate)}}
                                            </div>
                                        </div>
                                        <span *ngIf="selectedCardIndex === i" class="view_cvv"
                                            (click)="isShowBack[i]=!isShowBack[i]">Vedi CVV</span>
                                    </div>
                                    <div class="credit-card__back" *ngIf="isShowBack[i]">
                                        <div (click)="isShowBack[i]=!isShowBack[i]" class="credit-card__strip">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"
                                                fill="currentColor" class="bi bi-arrow-left mx-2 my-3"
                                                viewBox="0 0 16 16">
                                                <path fill-rule="evenodd"
                                                    d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8" />
                                            </svg>
                                        </div>
                                        <div>
                                            <svg *ngIf="!isShowCvv[i]" (click)="isShowCvv[i] = !isShowCvv[i]"
                                                xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                fill="currentColor" class="bi bi-eye-slash credit-card-show-action"
                                                viewBox="0 0 16 16">
                                                <path
                                                    d="M13.359 11.238C15.06 9.72 16 8 16 8s-3-5.5-8-5.5a7 7 0 0 0-2.79.588l.77.771A6 6 0 0 1 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755q-.247.248-.517.486z" />
                                                <path
                                                    d="M11.297 9.176a3.5 3.5 0 0 0-4.474-4.474l.823.823a2.5 2.5 0 0 1 2.829 2.829zm-2.943 1.299.822.822a3.5 3.5 0 0 1-4.474-4.474l.823.823a2.5 2.5 0 0 0 2.829 2.829" />
                                                <path
                                                    d="M3.35 5.47q-.27.24-.518.487A13 13 0 0 0 1.172 8l.195.288c.335.48.83 1.12 1.465 1.755C4.121 11.332 5.881 12.5 8 12.5c.716 0 1.39-.133 2.02-.36l.77.772A7 7 0 0 1 8 13.5C3 13.5 0 8 0 8s.939-1.721 2.641-3.238l.708.709zm10.296 8.884-12-12 .708-.708 12 12z" />
                                            </svg>
                                            <svg *ngIf="isShowCvv[i]" (click)="isShowCvv[i] = !isShowCvv[i]"
                                                xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                                                fill="currentColor" class="bi bi-eye credit-card-show-action"
                                                viewBox="0 0 16 16">
                                                <path
                                                    d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z" />
                                                <path
                                                    d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0" />
                                            </svg>
                                            <div class="credit-card__cvv">
                                                <span *ngIf="!isShowCvv[i]">***</span>
                                                <span *ngIf="isShowCvv[i]">{{getCvv(card)}}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-secondary mt-4"
                        *ngIf="cardList.length <= 0 && paymentMethodStep2FormComponent?.contrassegnoSelected === 'Carta di credito'">
                        Nessuna carta di credito presente
                    </div>
                    <span
                        *ngIf="!isShowCreditCard && paymentMethodStep2FormComponent?.contrassegnoSelected === 'Carta di credito'"
                        class="add-card mt-4 pointer" (click)="isShowCreditCard = !isShowCreditCard">Aggiungi carta di
                        credito</span>
                    <div class="mt-4"
                        *ngIf="paymentMethodStep2FormComponent?.contrassegnoSelected === 'Carta di credito' && isShowCreditCard">
                        <div>
                            <h1>Aggiungi carta di credito</h1>
                            <div class="d-flex flex-row" style="gap:30px">
                                <form (ngSubmit)="addCreditCard()" class="w-100 card-form p-3" #creditCardForm="ngForm">
                                    <div class="form-group mb-2">
                                        <label for="cardName">Nome sulla carta</label>
                                        <input type="text" class="form-control border-0 card-input" id="cardName"
                                            name="cardName" required (input)="updateCardName($event)">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label for="cardNumber">Numero carta di credito</label>
                                        <input type="text" class="form-control border-0 card-input" id="cardName"
                                            name="cardName" required (input)="updateCardNumber($event)">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label for="expiryDate">Data di scadenza</label>
                                        <input type="text" class="form-control border-0 card-input" id="expiryDate"
                                            name="expiryDate" placeholder="MM/YYYY" required
                                            (bsValueChange)="updateExpiryDate($event)" bsDatepicker [bsConfig]="{
                                                minMode: 'month',
                                                adaptivePosition: true,
                                                dateInputFormat: 'MM/YYYY',
                                                minDate: minExpiryDate
                                            }">
                                    </div>
                                    <div class="form-group mb-2">
                                        <label for="cvv">CVV</label>
                                        <input type="text" class="form-control border-0 card-input" id="cvv" name="cvv"
                                            required (input)="updateCvv($event)">
                                    </div>
                                    <div class="mt-3 d-flex flex-row" style="gap:20px">
                                        <button style="
                                        width: -webkit-fill-available;
                                        height: -webkit-fill-available;" class="btn btn-secondary"
                                            (click)="isShowCreditCard = !isShowCreditCard">Annulla</button>
                                        <button style="
                                        width: -webkit-fill-available;
                                        height: -webkit-fill-available;" type="submit"
                                            class="btn btn-color-no-hover text-white">Salva</button>
                                    </div>
                                </form>
                                <div class="border-left" style="width: 1px; background: #62686e;"></div>
                                <div>
                                    <p class="text-secondary">Accettiamo tutte le principali carte di credito e di
                                        debito:</p>
                                    <div class="d-flex flex-row"><span style="background-image: url('/assets/img/cards.png'); background-position: 0px; margin-right: 6px; margin-right: 6px;
                                            width: 45px;
                                            display: block;
                                            height: 30px;
                                            border-radius: 5px;"></span><span style="background-image: url('/assets/img/cards.png'); background-position: -45px;margin-right: 6px;
                                            width: 45px;
                                            display: block;
                                            height: 30px;
                                            border-radius: 5px;"></span>
                                        <span style="background-image: url('/assets/img/cards.png'); background-position: -90px; margin-right: 6px;margin-right: 6px;
                                            width: 45px;
                                            display: block;
                                            height: 30px;
                                            border-radius: 5px;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div [ngClass]="!isShowAddAddress ? 'mb-5' : '' " class="container d-flex flex-column">
                    <h1>Indirizzo</h1>
                    <div class="mb-4" *ngIf="addressList.length > 0">
                        <span class="text-secondary">Lista Indirizzi</span>
                        <div class="row">
                            <div class="col-xl-4 col-12 pointer" *ngFor="let address of addressList; let i = index">
                                <div (click)="selectedAddressIndex = i" class="d-flex flex-column rounded"
                                    style="border: 1px; border-style: dashed; padding: 10px;">
                                    <div class="d-flex flex-row" style="gap:5px">
                                        <input [checked]="selectedAddressIndex === i || (selectedAddressIndex === undefined && i === 0)"
                                            class="mb-1" type="radio" name="address" id="{{'address-'+i}}">
                                        <span>{{address.firstName}}</span>
                                        <span>{{address.lastName}}</span>
                                    </div>
                                    <div class="d-flex flex-row mt-2" style="margin-left: 18px;">
                                        <span>{{address.street}}</span>
                                    </div>
                                    <div class="d-flex flex-row mt-2" style="margin-left: 18px;">
                                        <span>{{address.city}} ({{address.state}}), {{address.zip}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                    
                    <div class="mb-4 text-secondary" *ngIf="addressList.length <= 0">
                        Nessun indirizzo presente
                    </div>
                    <span *ngIf="!isShowAddAddress" class="add-card pointer"
                        (click)="isShowAddAddress = !isShowAddAddress">Aggiungi Indirizzo
                    </span>
                </div>
                <div *ngIf="isShowAddAddress" class="container d-flex flex-column mb-5">
                    <h1>Aggiungi indirizzo</h1>
                    <unievent-payment-step2-payment-address-form (addAddressEvent)="addAddress($event)"
                        (clearAddressEvent)="isShowAddAddress = !isShowAddAddress"></unievent-payment-step2-payment-address-form>
                </div>
                <div class="py-3 d-flex justify-content-end mt-4">
                    <button class="btn btn-secondary rounded-0 mx-3" style="margin-top:-1px" mat-button
                        matStepperPrevious>Indietro</button>
                    <button class="btn btn-primary btn-color-no-hover rounded-0" mat-button
                        matStepperNext>Avanti</button>
                </div>
            </form>
        </mat-step>
        <mat-step>
            <ng-template matStepLabel>Riepilogo</ng-template>
            <div class="container mb-5">
                <h1 class="mb-0">Riepilogo</h1>
                <hr class="m-0 mt-3 mb-3">
                <div class="d-flex flex-column" style="gap:15px">
                    <span>Numero biglietti: {{eventTicketList?.length}}</span>
                    <div class="d-flex flex-column">
                        <div class="d-flex flex-column" *ngFor="let objectMap of eventTicketList">
                            <span>1 x Biglietto {{getTypeByEvent(objectMap)}}, {{objectMap.n_object_price}}€</span>
                        </div>
                        <div class="mt-3">Commissioni di servizio: {{((getTotalPrice() * commissionsOfService) /
                            100).toFixed(2)}}€</div>
                        <div *ngIf="getShippingFee() > 0" class="mt-3">Spese di spedizione: {{getShippingFee()}} €
                        </div>
                    </div>
                    <div *ngIf="paymentMethodStep2FormComponent?.contrassegnoSelected === 'Contrassegno' ">
                        Contrassegno: {{contrassegnoFee}}€</div>
                    <hr class="m-0">
                    <span>Totale: {{(getTotalPrice() + ((getTotalPrice() * commissionsOfService) / 100) +
                        getShippingFee()).toFixed(2)}}€</span>
                </div>
            </div>
            <div>
                <button class="btn btn-secondary rounded-0 mx-3" style="margin-top:-1px" mat-button
                    matStepperPrevious>Indietro</button>
                <button mat-button matStepperNext class="btn btn-primary btn-color-no-hover rounded-0">Conferma
                    ordine</button>
            </div>
        </mat-step>
        <mat-step>
            <ng-template matStepLabel>Esito</ng-template>
            <div class="container mb-5">
                <div class="container d-flex flex-column justify-content-center align-items-center">
                    <div class="success-icon mb-5 mt-5">&#10004;</div>
                    <div class="message mt-3">Pagamento completato con successo!</div>
                    <div class="redirect-message mt-3">Verrai reindirizzato alla homepage tra <span
                            id="countdown">{{redirectCountdown}}</span> secondi. Oppure clicca <a href="/">qui</a> per
                        tornare immediatamente.</div>
                </div>
            </div>
        </mat-step>
    </mat-stepper>
</div>